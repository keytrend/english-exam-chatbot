<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì˜ì–´ íŠœí„°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            margin: 0;
            padding: 0;
        }

        .chatbot-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ===== ë¡œê·¸ì¸ ===== */
        .login-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }
        .login-area h2 { margin-bottom: 8px; color: #333; }
        .login-area p { color: #666; margin-bottom: 24px; }
        .login-area input {
            width: 100%; max-width: 360px;
            padding: 12px 16px; margin: 6px 0;
            border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;
        }
        .login-area button {
            width: 100%; max-width: 360px;
            padding: 12px; margin-top: 16px;
            background: #667eea; color: white; border: none;
            border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
        }
        .login-area button:hover { background: #5568d3; }

        /* ===== ì±„íŒ… ì˜ì—­ ===== */
        #chatArea { display: none; flex-direction: column; flex: 1; min-height: 0; }
        #chatArea.visible { display: flex; }
        #loginArea.hidden { display: none; }

        /* ===== í—¤ë” (ê³ ì •) ===== */
        .chatbot-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 16px 20px; text-align: center;
            flex-shrink: 0; position: relative;
        }
        .chatbot-header h1 { font-size: 22px; margin-bottom: 4px; }
        .usage-info { font-size: 13px; opacity: 0.9; }

        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
        .logout-btn {
            position: absolute; top: 14px; right: 16px;
            background: rgba(255,255,255,0.2); color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 4px 10px; border-radius: 12px;
            font-size: 12px; cursor: pointer;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.35); }

        /* ===== ë©”ì‹œì§€ ìŠ¤í¬ë¡¤ ì˜ì—­ ===== */
        .chat-messages {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 16px 20px;
            background: #fafafa;
        }

        /* ===== ë©”ì‹œì§€ ===== */
        .message { margin-bottom: 12px; }
        .message.user { text-align: right; }
        .message.bot  { text-align: left; }

        .bubble {
            display: inline-block;
            max-width: 88%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 15px;
            word-break: break-word;
            text-align: left;
        }
        .message.user .bubble { background: #667eea; color: white; }
        .message.bot  .bubble { background: white; border: 1px solid #e0e0e0; color: #333; }

        /* ë´‡ ë‹µë³€ ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
        .message.bot .bubble strong { color: #667eea; font-weight: 700; }
        .message.bot .bubble em { color: #555; font-style: italic; }
        .message.bot .bubble code {
            background: #f0f3ff; color: #667eea;
            padding: 1px 6px; border-radius: 3px; font-size: 14px;
            font-family: 'Consolas', monospace;
        }

        /* ëª¨ë“  ì¤„ ë™ì¼ ìŠ¤íƒ€ì¼ â†’ ì¢Œì¸¡ ì •ë ¬ í†µì¼ */
        .message.bot .bubble .line {
            display: block;
            text-align: left;
            padding-left: 0;
            margin-left: 0;
            line-height: 1.7;
            margin-bottom: 1px;
        }
        .message.bot .bubble .gap { height: 8px; }
        .message.bot .bubble .divider { height: 1px; background: #eee; margin: 4px 0; }

        .msg-time { font-size: 11px; color: #999; margin-top: 3px; }
        .message.user .msg-time { text-align: right; }

        /* ===== ë¡œë”© / ì—ëŸ¬ ===== */
        .loading { display: none; padding: 8px; text-align: center; color: #667eea; flex-shrink: 0; }
        .loading.active { display: block; }
        .error-message { background: #fee; color: #c33; padding: 10px 16px; border-radius: 6px; margin: 6px 16px; display: none; flex-shrink: 0; }
        .error-message.active { display: block; }

        /* ===== ì…ë ¥ ì˜ì—­ (ê³ ì •) ===== */
        .chat-input-area { padding: 12px 16px; background: white; border-top: 1px solid #e0e0e0; flex-shrink: 0; }
        .input-wrapper { display: flex; gap: 8px; }
        #questionInput {
            flex: 1; padding: 10px 14px;
            border: 2px solid #e0e0e0; border-radius: 20px;
            font-size: 15px; outline: none;
        }
        #questionInput:focus { border-color: #667eea; }
        #sendButton {
            padding: 10px 22px; background: #667eea; color: white;
            border: none; border-radius: 20px; font-size: 15px;
            font-weight: 600; cursor: pointer;
        }
        #sendButton:hover { background: #5568d3; }
        #sendButton:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
<div class="chatbot-container">

    <!-- ë¡œê·¸ì¸ -->
    <div id="loginArea" class="login-area">
        <h2>ğŸ“ AI ì˜ì–´ íŠœí„°</h2>
        <p>ë¡œê·¸ì¸í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</p>
        <input type="text" id="userId" placeholder="ì‚¬ìš©ì ID" />
        <input type="email" id="userEmail" placeholder="ì´ë©”ì¼" />
        <button onclick="login()">ë¡œê·¸ì¸</button>
    </div>

    <!-- ì±„íŒ… -->
    <div id="chatArea">
        <div class="chatbot-header">
            <h1>ğŸ“ AI ì˜ì–´ íŠœí„°</h1>
            <div class="usage-info" id="usageInfo">ë‚¨ì€ ì§ˆë¬¸ íšŸìˆ˜(ê°„ë‹¨í•œ ì§ˆë¬¸: -, ë³µì¡í•œ ì§ˆë¬¸: -)</div>
            <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div class="error-message" id="errorMessage"></div>
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="bubble">
                    <div class="line">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</div>
                    <div class="line">ìˆ˜ëŠ¥ ì˜ì–´ ì§ˆë¬¸ì„ ììœ ë¡­ê²Œ í•´ì£¼ì„¸ìš”.</div>
                    <div class="line">ì–´íœ˜, ë¬¸ë²•, ë…í•´ ë“± ë¬´ì—‡ì´ë“  ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!</div>
                </div>
                <div class="msg-time">...</div>
            </div>
        </div>
        <div class="loading" id="loading">ë‹µë³€ ìƒì„± ì¤‘...</div>
        <div class="chat-input-area">
            <div class="input-wrapper">
                <input type="text" id="questionInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter')sendQuestion()" />
                <button id="sendButton" onclick="sendQuestion()">ì „ì†¡</button>
            </div>
        </div>
    </div>

</div>

<script>
var API_URL = 'http://localhost:3000';
var authToken = localStorage.getItem('authToken');

// ---- í˜ì´ì§€ ë¡œë“œ ----
window.onload = function() {
    if (authToken) {
        showChatArea();
        loadUsageInfo();
    }
};

// ---- ë¡œê·¸ì¸ ----
async function login() {
    var userId = document.getElementById('userId').value.trim();
    var userEmail = document.getElementById('userEmail').value.trim();
    if (!userId || !userEmail) return showError('ì‚¬ìš©ì IDì™€ ì´ë©”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');

    try {
        var res = await fetch(API_URL + '/api/auth/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: userId, userEmail: userEmail })
        });
        var data = await res.json();
        if (data.token) {
            authToken = data.token;
            localStorage.setItem('authToken', authToken);
            showChatArea();
            loadUsageInfo();
        } else {
            showError(data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
        }
    } catch(e) {
        showError('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    }
}

// ---- ë¡œê·¸ì•„ì›ƒ ----
function logout() {
    localStorage.clear();
    authToken = null;
    document.getElementById('chatArea').classList.remove('visible');
    document.getElementById('loginArea').classList.remove('hidden');
    document.getElementById('userId').value = '';
    document.getElementById('userEmail').value = '';
}

// ---- í† í° ë§Œë£Œ ì²´í¬ ----
function checkAuthError(res) {
    if (res.status === 401 || res.status === 403) {
        logout();
        showError('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        return true;
    }
    return false;
}

// ---- ì±„íŒ… ì˜ì—­ í‘œì‹œ ----
function showChatArea() {
    document.getElementById('loginArea').classList.add('hidden');
    document.getElementById('chatArea').classList.add('visible');
}

// ---- ì‚¬ìš©ëŸ‰ ë¡œë“œ ----
async function loadUsageInfo() {
    try {
        var res = await fetch(API_URL + '/api/usage', {
            headers: { 'Authorization': 'Bearer ' + authToken }
        });
        if (checkAuthError(res)) return;
        var data = await res.json();
        if (data['ì„±ê³µ']) {
            document.getElementById('usageInfo').textContent =
                'ë‚¨ì€ ì§ˆë¬¸ íšŸìˆ˜(ê°„ë‹¨í•œ ì§ˆë¬¸: ' + data['ì´ë²ˆë‹¬']['ê°„ë‹¨í•œì§ˆë¬¸']['ë‚¨ìŒ'] +
                ', ë³µì¡í•œ ì§ˆë¬¸: ' + data['ì´ë²ˆë‹¬']['ë³µì¡í•œì§ˆë¬¸']['ë‚¨ìŒ'] + ')';
        }
    } catch(e) { console.error(e); }
}

// ---- ì§ˆë¬¸ ì „ì†¡ ----
async function sendQuestion() {
    var input = document.getElementById('questionInput');
    var question = input.value.trim();
    if (!question) return;

    addMessage(question, 'user');
    input.value = '';
    document.getElementById('sendButton').disabled = true;
    document.getElementById('loading').classList.add('active');

    try {
        var res = await fetch(API_URL + '/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + authToken },
            body: JSON.stringify({ question: question, context: 'ìˆ˜ëŠ¥ ì˜ì–´ í•™ìŠµ' })
        });
        if (checkAuthError(res)) return;
        var data = await res.json();
        if (data.answer) {
            addMessage(data.answer, 'bot');
            loadUsageInfo();
        } else {
            showError(data.message || 'ë‹µë³€ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    } catch(e) {
        showError('ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    } finally {
        document.getElementById('sendButton').disabled = false;
        document.getElementById('loading').classList.remove('active');
    }
}

// ===== Markdown â†’ HTML ë³€í™˜ =====
function formatMessage(rawText) {
    // 1. HTML ì´ìŠ¤ì¼€ì´í”„
    var text = rawText
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

    // 2. ì¤„ë°”ê¿ˆ ì •ë¦¬
    text = text.replace(/\n{3,}/g, '\n\n');

    // 3. ## í—¤ë” â†’ bold
    text = text.replace(/#{1,6}\s+(.*)/g, '**$1**');

    // 4. ì¸ë¼ì¸ ë³€í™˜
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/(?<!\w)\*([^*\n]+?)\*(?!\w)/g, '<em>$1</em>');
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

    // 5. ì¤„ ë‹¨ìœ„ ì²˜ë¦¬
    var lines = text.split('\n');
    var html = '';

    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim(); // trim ìœ¼ë¡œ ëª¨ë“  ì•ë’¤ ê³µë°± ì œê±° â†’ ì¢Œì¸¡ ì •ë ¬ í†µì¼

        // ë¹ˆ ì¤„
        if (line === '') { html += '<div class="gap"></div>'; continue; }

        // êµ¬ë¶„ì„ 
        if (/^[-_*]{3,}$/.test(line)) { html += '<div class="divider"></div>'; continue; }

        // ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸
        var numM = line.match(/^(\d+)[.)]\s+([\s\S]*)/);
        if (numM) {
            html += '<div class="line">ğŸ“Œ <strong>' + numM[1] + '.</strong> ' + numM[2] + '</div>';
            continue;
        }

        // ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸
        var bulM = line.match(/^[-â€¢]\s+([\s\S]*)/);
        if (bulM) {
            html += '<div class="line">â€¢ ' + bulM[1] + '</div>';
            continue;
        }

        // ì œëª©ë§Œ ìˆëŠ” ì¤„ ê°ì§€: <strong>...</strong>
        var titM = line.match(/^(<strong>[^<]+<\/strong>)\s*:?\s*$/);
        if (titM) {
            var ni = i + 1;
            while (ni < lines.length && lines[ni].trim() === '') ni++;

            if (ni < lines.length) {
                var nextLine = lines[ni].trim();
                var nextIsList = /^[-â€¢]\s/.test(nextLine) || /^\d+[.)]\s/.test(nextLine);
                var nextIsTitle = /^<strong>/.test(nextLine);

                // ë‹¤ìŒì´ ë¦¬ìŠ¤íŠ¸/ì œëª©ì´ ì•„ë‹ˆë©´ í•©ì¹¨
                if (!nextIsList && !nextIsTitle && !/^[-_*]{3,}$/.test(nextLine)) {
                    html += '<div class="line">' + titM[1] + ': ' + nextLine + '</div>';
                    i = ni;
                    continue;
                }
            }
            // ë‹¤ìŒì´ ë¦¬ìŠ¤íŠ¸ì´ë©´ ì œëª© ë‹¨ë…
            html += '<div class="gap"></div>';
            html += '<div class="line">' + titM[1] + '</div>';
            continue;
        }

        // ì¼ë°˜ í…ìŠ¤íŠ¸
        html += '<div class="line">' + line + '</div>';
    }

    return html;
}

// ---- ë©”ì‹œì§€ ì¶”ê°€ ----
function addMessage(text, sender) {
    var container = document.getElementById('chatMessages');

    var msgDiv = document.createElement('div');
    msgDiv.className = 'message ' + sender;

    var bubble = document.createElement('div');
    bubble.className = 'bubble';

    if (sender === 'bot') {
        bubble.innerHTML = formatMessage(text);
    } else {
        bubble.textContent = text;
    }

    var timeDiv = document.createElement('div');
    timeDiv.className = 'msg-time';
    timeDiv.textContent = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

    msgDiv.appendChild(bubble);
    msgDiv.appendChild(timeDiv);
    container.appendChild(msgDiv);
    container.scrollTop = container.scrollHeight;
}

// ---- ì—ëŸ¬ í‘œì‹œ ----
function showError(msg) {
    var el = document.getElementById('errorMessage');
    el.textContent = msg;
    el.classList.add('active');
    setTimeout(function() { el.classList.remove('active'); }, 5000);
}
</script>
</body>
</html>
